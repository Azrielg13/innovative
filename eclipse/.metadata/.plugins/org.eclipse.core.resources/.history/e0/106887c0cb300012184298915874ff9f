package com.sce.esp.component.richtext;

import java.awt.event.ActionEvent;
import java.util.Iterator;
import java.util.Map;

import javax.swing.JTextPane;
import javax.swing.text.Element;
import javax.swing.text.MutableAttributeSet;
import javax.swing.text.SimpleAttributeSet;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyledEditorKit;
import javax.swing.text.html.HTML;
import javax.swing.text.html.HTMLDocument;


public class FormatAction extends StyledEditorKit.StyledTextAction {

    /**
	 * 
	 */
	private static final long serialVersionUID = 4152664060829177387L;
	private HTML.Tag htmlTag;
    private Map<String, String> attributes;
    private MetaphaseEditorPanel editorPanel;

    public FormatAction(MetaphaseEditorPanel editorPanel, String actionName, HTML.Tag htmlTag) {
            super(actionName);
            this.editorPanel = editorPanel;
            this.htmlTag = htmlTag;
            attributes = null;
    }

    public FormatAction(MetaphaseEditorPanel editorPanel, String actionName, HTML.Tag htmlTag, Map<String, String> attributes) {
            super(actionName);
            this.editorPanel = editorPanel;
            this.htmlTag = htmlTag;
            this.attributes = attributes;
    }

    public FormatAction(MetaphaseEditorPanel editorPanel, String actionName, Map<String, String> attributes) {
            super(actionName);
            this.editorPanel = editorPanel;
            htmlTag = null;
            this.attributes = attributes;
    }

    public void actionPerformed(ActionEvent ae) {
        JTextPane textPane = editorPanel.getHtmlTextPane();
        HTMLDocument htmlDocument = (HTMLDocument) textPane.getDocument();

        int start = textPane.getSelectionStart();
        int end = textPane.getSelectionEnd();

        Element element = htmlDocument.getParagraphElement(start);
        MutableAttributeSet newAttrs = new SimpleAttributeSet(element.getAttributes());
        if (htmlTag != null) {
            newAttrs.addAttribute(StyleConstants.NameAttribute, htmlTag);
        }
        if (attributes != null) {
            Iterator iterator = attributes.entrySet().iterator();
            while (iterator.hasNext()) {
                Map.Entry entry = (Map.Entry)iterator.next();
                newAttrs.addAttribute(entry.getKey(), entry.getValue());
            }
        }

        htmlDocument.setParagraphAttributes(start, end - start, newAttrs, true);
        editorPanel.refreshAfterAction();
    }
}
